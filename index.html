<!DOCTYPE html>
<html lang="es">

<head>
    <base href="/tallerv4/">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Taller de Costura</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css" />
    <!-- En index.html -->


    <!-- PWA Manifest (rutas relativas SIN / inicial) -->
    <link rel="manifest" href="manifest.json">

    <!-- Meta tags para PWA -->
    <meta name="theme-color" content="#4a5568">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes"> <!-- Correcci√≥n para Chrome -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Iconos (rutas relativas SIN / inicial) -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" href="icons/icon-192x192.png" sizes="192x192">
</head>

<body>
    <!-- Contenedor principal -->
    <div id="app">
        <p>Cargando aplicaci√≥n 1 2 3...</p>
    </div>

    <!-- Dexie.js desde CDN (¬°SIN ESPACIOS!) -->
    <script src="https://unpkg.com/dexie@4.0.8/dist/dexie.js"></script>

    <!-- Scripts de la app -->
    <script type="module" src="js/db.js"></script>
    <script type="module" src="js/app.js"></script>

    <!-- Service Worker Registration (al final, despu√©s de los m√≥dulos) -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    // Esperar a que se carguen los m√≥dulos primero
                    await new Promise(resolve => setTimeout(resolve, 500));


                    const registration = await navigator.serviceWorker.register('./service-worker.js');


                    console.log('‚úÖ ServiceWorker registrado con √©xito:', registration.scope);

                    // Forzar actualizaci√≥n si hay nueva versi√≥n
                    registration.onupdatefound = () => {
                        const installingWorker = registration.installing;
                        installingWorker.onstatechange = async () => {
                            if (installingWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    console.log('üîÑ Nueva versi√≥n disponible. Recargando...');

                                    // Mostrar notificaci√≥n al usuario
                                    if (confirm('¬°Nueva versi√≥n disponible! ¬øRecargar para actualizar?')) {
                                        window.location.reload();
                                    }
                                } else {
                                    console.log('‚úÖ App est√° lista para funcionar offline');
                                }
                            }
                        };
                    };
                } catch (error) {
                    console.error('‚ùå Error al registrar ServiceWorker:', error);

                    // Modo degradado pero funcional
                    console.warn('‚ö†Ô∏è La app funcionar√° pero sin modo offline');
                }
            });
        } else {
            console.warn('‚ö†Ô∏è ServiceWorker no soportado en este navegador');
        }
    </script>
</body>

</html>
